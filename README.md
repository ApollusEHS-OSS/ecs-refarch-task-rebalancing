# Rebalancing Amazon ECS Tasks using AWS Lambda##Introduction Containerization offers many benefits to modern microservices architectures. Amazon EC2 Container Service (ECS) allows you to easily run Docker Containers on a managed cluster of Amazon EC2 instances. Amazon ECS eliminates the need for you to install, operate, and scale your own cluster management infrastructure. As an organization grows in maturity, cost optimizations such as Auto-Scaling and CI/CD methods such as Blue/Green deployments can create a lot of churn in the environment. Consider an ECS cluster with tasks distributed evenly across multiple ECS instances within the cluster.  If the cluster is scaled down in order to save cost, the tasks on the removed instance are assigned to remaining nodes automatically. However, when the ECS cluster is scaled up again, tasks are not automatically redistributed across all available instances.  This leads to unused capacity and an under-utilized cluster.  In this reference architecture, we will demonstrate a serverless approach using AWS Lambda and Amazon ECS Event Stream to proactively rebalance the ECS tasks.### Create an ECS Cluster and Deploy a Sample App For your convenience, we have created a CloudFormation template that will create the core infrastructure that we will use throughout this blog. 1.	Create a new Stack from the AWS Console. <https://console.aws.amazon.com/cloudformation/>2.	Select “Specify an Amazon S3 template” and use the following template URL: <https://link.tbd>3.	Configure a Name for the stack and select an existing ECS KeyPair for the region in which you are deploying. 

	*The default configuration allows SSH access from any IP address. Please consider configuring this to only allow access from your network range or host.*4.	Complete the wizard and confirm that the stack creates successfully. Under the Outputs tab, you’ll find the Application URL listed as ECSALB. Cut and paste this into your browser. 	**You should see a Congratulations page confirming that your ECS Service is running as expected.**### Explore the ECS Cluster1.	Review Settings in the ECS Console2.	Verify that the Site is up.Scale Down the ECS Cluster Size1.	Change the ASG Settings2.	Look at ECS Settings. Illustrate default task behavior3.	Change ASG Setting to scale the cluster back up.4.	Illustrate that Tasks did not balance across the 3 nodes.### Use ECS Events to Rebalance TasksWe propose a solution that listens to “ECS Container Instance State Change” events on the ECS event stream (https://aws.amazon.com/blogs/compute/monitor-cluster-state-with-amazon-ecs-event-stream/ http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_cwet.html) and triggers a lambda that rebalances tasks on the ECS cluster. DiagramThis involves:1.	Creating a Lambda function that will rebalance tasks on ECS cluster by updating the service deployed on the cluster.  2.	Creating a Cloud Watch Event, that uses “ECS Container Instance State Change” event from the ECS event stream as a trigger to execute the lambda function that rebalances the tasks.### Create the Lambda FunctionLambda Overview```Lambda Function with Comments```### Deploy the Lambda Function
1. Create an S3 Bucket
2. Upload the zip file containing the Lambda function.

A CloudFormation template has been provided to configure the Lambda Function and CloudWatch Triggers.
### Scale the Cluster and Validate Task Rebalancing1.	Repeat the scaling tasks from before to scale down the cluster2.	Check Lambda / CWE3.	Verify Placement4.	Scale Up5.	Check Lambda / CWE6.	Verify Placement